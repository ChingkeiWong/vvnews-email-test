#!/bin/bash

# åˆ‡æ¢åˆ°è„šæœ¬æ‰€åœ¨ç›®å½•
cd "$(dirname "$0")"

# VVNews Bot (24å°æ—¶ç‰ˆæœ¬) - ä¸“ç”¨å¯åŠ¨è„šæœ¬
echo "ğŸ¯ VVNews Bot - 24å°æ—¶ç‰ˆæœ¬ä¸“ç”¨å¯åŠ¨"
echo "=========================================="
echo "ğŸ“° æœç´¢èŒƒå›´: è¿‡å»24å°æ—¶"
echo "ğŸ” è¦†ç›–æ‰€æœ‰9ä¸ªé¦™æ¸¯ä¸»æµæ–°é—»æº"
echo "ğŸ“§ è‡ªåŠ¨å‘é€é‚®ä»¶é€šçŸ¥"
echo "=========================================="

# æ£€æŸ¥Pythonæ˜¯å¦å®‰è£…
if ! command -v python3 &> /dev/null; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Python3ï¼Œè¯·å…ˆå®‰è£… Python3"
    read -p "æŒ‰ä»»æ„é”®é€€å‡º..."
    exit 1
fi

echo "âœ… Python3 å·²å®‰è£…: $(python3 --version)"

# æ£€æŸ¥vvnews_bot.pyæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "vvnews_bot.py" ]; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° vvnews_bot.py æ–‡ä»¶"
    echo "è¯·ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬"
    read -p "æŒ‰ä»»æ„é”®é€€å‡º..."
    exit 1
fi

echo "âœ… vvnews_bot.py æ–‡ä»¶å·²æ‰¾åˆ°"

# æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒæ˜¯å¦å­˜åœ¨
if [ ! -d "venv" ]; then
    echo "ğŸ“¦ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv venv
    if [ $? -eq 0 ]; then
        echo "âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ"
    else
        echo "âŒ è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå¤±è´¥"
        read -p "æŒ‰ä»»æ„é”®é€€å‡º..."
        exit 1
    fi
else
    echo "âœ… è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨"
fi

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
echo "ğŸ”§ æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ..."
source venv/bin/activate

# æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
echo "ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–åŒ…..."
if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt --quiet
    if [ $? -eq 0 ]; then
        echo "âœ… ä¾èµ–åŒ…å®‰è£…å®Œæˆ"
    else
        echo "âš ï¸ ä¾èµ–åŒ…å®‰è£…å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†ç»§ç»­è¿è¡Œ..."
    fi
else
    echo "âš ï¸ æœªæ‰¾åˆ°requirements.txtï¼Œæ‰‹åŠ¨å®‰è£…åŸºç¡€ä¾èµ–..."
    pip install requests beautifulsoup4 lxml --quiet
fi

# åˆ›å»ºresultsç›®å½•
if [ ! -d "results" ]; then
    echo "ğŸ“ åˆ›å»ºresultsç›®å½•..."
    mkdir -p results
fi

# æ£€æŸ¥é‚®ä»¶é…ç½®
if [ -f "email_config.py" ]; then
    echo "âœ… é‚®ä»¶é…ç½®æ–‡ä»¶å·²æ‰¾åˆ°"
else
    echo "âš ï¸ æœªæ‰¾åˆ°email_config.pyï¼Œå°†ä½¿ç”¨é»˜è®¤é‚®ä»¶é…ç½®"
fi

echo ""
echo "ğŸš€ å¯åŠ¨VVNews Bot (24å°æ—¶ç‰ˆæœ¬)..."
echo "â° å¼€å§‹æœç´¢è¿‡å»24å°æ—¶çš„ç‹æ•å¥•ç›¸å…³æ–°é—»..."
echo "ğŸ”„ è¯·è€å¿ƒç­‰å¾…æœç´¢å®Œæˆ..."
echo "=========================================="

# è¿è¡Œæœºå™¨äºº
python3 vvnews_bot.py

# æ£€æŸ¥è¿è¡Œç»“æœ
if [ $? -eq 0 ]; then
    echo "=========================================="
    echo "ğŸ‰ VVNews Bot (24å°æ—¶ç‰ˆæœ¬) è¿è¡Œå®Œæˆï¼"
    echo "âœ… æœç´¢æˆåŠŸå®Œæˆ"
    echo "ğŸ“ ç»“æœæ–‡ä»¶ä¿å­˜åœ¨: ./results/"
    echo "ğŸ“§ é‚®ä»¶é€šçŸ¥å·²å‘é€åˆ°é…ç½®çš„é‚®ç®±"
    echo "ğŸ• è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
else
    echo "=========================================="
    echo "âŒ VVNews Bot è¿è¡Œå‡ºç°é”™è¯¯"
    echo "ğŸ’¡ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé…ç½®æ–‡ä»¶"
    echo "ğŸ” æŸ¥çœ‹ä¸Šæ–¹é”™è¯¯ä¿¡æ¯è¿›è¡Œæ’æŸ¥"
fi

echo ""
echo "ğŸ“Š è¿è¡Œç»Ÿè®¡:"
if [ -d "results" ]; then
    result_count=$(ls -1 results/*.txt 2>/dev/null | wc -l)
    echo "ğŸ“„ ç»“æœæ–‡ä»¶æ•°é‡: $result_count"
fi

echo "=========================================="
# ä¿æŒçª—å£æ‰“å¼€
read -p "æŒ‰ä»»æ„é”®é€€å‡º..."
