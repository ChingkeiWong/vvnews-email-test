name: VVNewså®šæ—¶è§¦å‘ - ç‹æ•å¥•æ–°é—»ç›‘æ§

on:
  schedule:
    # æ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (åŒ—äº¬æ—¶é—´æ¯å°æ—¶çš„ 0, 10, 20, 30, 40, 50 åˆ†)
    - cron: '*/10 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  trigger-render:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ è§¦å‘RenderæœåŠ¡
      run: |
        echo "ğŸš€ å¼€å§‹è§¦å‘RenderæœåŠ¡..."
        echo "â° è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ¯ ç›®æ ‡ä»“åº“: ChingkeiWong/vvnews_render"
        
        # è®¾ç½®RenderæœåŠ¡URL
        RENDER_URL="${{ secrets.RENDER_SERVICE_URL }}"
        
        if [ -z "$RENDER_URL" ]; then
          echo "âŒ é”™è¯¯: è¯·åœ¨GitHub Secretsä¸­è®¾ç½®RENDER_SERVICE_URL"
          echo "ğŸ’¡ ç¤ºä¾‹: https://vvnews-auto-service.onrender.com"
          exit 1
        fi
        
        echo "ğŸ¯ ç›®æ ‡æœåŠ¡: $RENDER_URL"
        
        # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
        echo "ğŸ“Š æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
        HEALTH_CODE=$(curl -s -w "%{http_code}" -o health.json "$RENDER_URL/health" --max-time 30 || echo "000")
        
        if [ "$HEALTH_CODE" = "200" ]; then
          echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "ğŸ“‹ å¥åº·çŠ¶æ€:"
          cat health.json | jq '.' 2>/dev/null || cat health.json
        else
          echo "âš ï¸ å¥åº·æ£€æŸ¥å¼‚å¸¸ï¼ŒçŠ¶æ€ç : $HEALTH_CODE"
          echo "ğŸ“‹ å“åº”å†…å®¹:"
          cat health.json 2>/dev/null || echo "æ— å“åº”å†…å®¹"
        fi
        
        # è§¦å‘æ–°é—»æ£€æŸ¥
        echo ""
        echo "ğŸ“° è§¦å‘æ–°é—»æ£€æŸ¥..."
        RUN_CODE=$(curl -s -w "%{http_code}" -o run.json "$RENDER_URL/run" --max-time 120 || echo "000")
        
        if [ "$RUN_CODE" = "200" ]; then
          echo "âœ… æ–°é—»æ£€æŸ¥è§¦å‘æˆåŠŸ"
          echo "ğŸ“‹ æ‰§è¡Œç»“æœ:"
          cat run.json | jq '.' 2>/dev/null || cat run.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–°é—»
          if grep -q "success" run.json && grep -q "æ–°æ–°é—»" run.json; then
            echo "ğŸ‰ å‘ç°æ–°æ–°é—»ï¼å·²å‘é€é‚®ä»¶é€šçŸ¥"
          elif grep -q "æ²¡æœ‰å‘ç°æ–°æ–°é—»" run.json; then
            echo "â„¹ï¸ æ²¡æœ‰å‘ç°æ–°æ–°é—»"
          fi
        else
          echo "âŒ æ–°é—»æ£€æŸ¥è§¦å‘å¤±è´¥ï¼ŒçŠ¶æ€ç : $RUN_CODE"
          echo "ğŸ“‹ é”™è¯¯ä¿¡æ¯:"
          cat run.json 2>/dev/null || echo "æ— å“åº”å†…å®¹"
        fi
        
        echo ""
        echo "ğŸ‰ è§¦å‘å®Œæˆï¼"
        
    - name: ğŸ“¤ ä¸Šä¼ å“åº”æ—¥å¿—
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: render-responses-${{ github.run_number }}
        path: |
          health.json
          run.json
        retention-days: 3

  # å¤‡ç”¨ä»»åŠ¡ï¼šå¦‚æœRenderæœåŠ¡å¤±è´¥ï¼Œåœ¨GitHub Actionsä¸­ç›´æ¥è¿è¡Œ
  backup-run:
    runs-on: ubuntu-latest
    needs: trigger-render
    if: failure()
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml
        
    - name: ğŸš¨ å¤‡ç”¨è¿è¡Œ - VVNews Auto Bot
      env:
        GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
        GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
      run: |
        echo "ğŸš¨ RenderæœåŠ¡ä¸å¯ç”¨ï¼Œå¯åŠ¨å¤‡ç”¨æœ¬åœ°è¿è¡Œæ¨¡å¼"
        echo "â° è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ“§ é‚®ç®±é…ç½®: $GMAIL_EMAIL"
        
        # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
        if [ ! -f "vvnews_bot_auto.py" ]; then
          echo "âŒ é”™è¯¯: vvnews_bot_auto.py æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è¿è¡Œæ–°é—»æ£€æŸ¥
        python vvnews_bot_auto.py
        
    - name: ğŸ“¤ ä¿å­˜å¤‡ç”¨è¿è¡Œç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backup-results-${{ github.run_number }}
        path: results/
        retention-days: 7
        
    - name: ğŸ“Š å¤‡ç”¨è¿è¡Œæ€»ç»“
      if: always()
      run: |
        echo "ğŸ“Š å¤‡ç”¨è¿è¡Œå®Œæˆ"
        echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ’¡ å»ºè®®æ£€æŸ¥RenderæœåŠ¡çŠ¶æ€å¹¶ä¿®å¤é—®é¢˜"
